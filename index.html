<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>2-7 Triple Draw</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --felt1:#1e6b35;--felt2:#175828;--felt3:#0f3e1c;
  --rail1:#9c6020;--rail2:#7a4a14;--rail3:#4a2a08;
  --gold:#d4a843;--gold2:#f0c84a;--goldglow:rgba(212,168,67,.35);
  --red:#c0392b;--blue:#2471a3;
  --bg:#080f09;
  --card-w:72px;--card-h:100px;
  --txt:#ddd8c8;--txt2:#8faf8f;--txt3:#4a6a4a;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Barlow Semi Condensed',sans-serif}

/* â”€â”€ LOBBY â”€â”€ */
#lobby{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:48px;
  background:radial-gradient(ellipse at 50% 45%,#163320 0%,var(--bg) 70%)}
.logo{text-align:center}
.logo-suits{font-size:44px;letter-spacing:14px;margin-bottom:8px}
.logo-suits .r{color:#e74c3c}.logo-suits .b{color:#a0c4a0}
.logo h1{font-size:68px;font-weight:700;letter-spacing:8px;color:var(--txt);
  text-shadow:0 0 60px var(--goldglow),0 3px 0 #000}
.logo p{font-size:13px;letter-spacing:5px;color:var(--txt3);margin-top:6px}
.diff-label{font-size:10px;letter-spacing:5px;color:var(--txt3);text-align:center;margin-bottom:14px}
.diff-row{display:flex;gap:14px}
.dc{width:164px;padding:28px 16px 22px;
  background:linear-gradient(160deg,#1c4823,#0e1a10);
  border:1px solid rgba(212,168,67,.2);border-radius:14px;
  cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:10px;
  transition:all .2s;position:relative;font-family:inherit}
.dc:hover{border-color:var(--gold);transform:translateY(-4px);
  box-shadow:0 12px 40px #0008,0 0 28px var(--goldglow)}
.dc.rec{border-color:rgba(212,168,67,.5)}
.rec-tag{position:absolute;top:-11px;left:50%;transform:translateX(-50%);
  background:var(--gold);color:#000;font-size:9px;font-weight:700;
  padding:2px 10px;border-radius:10px;letter-spacing:2px;white-space:nowrap}
.dc-icon{font-size:36px}
.dc-name{font-size:22px;font-weight:700;letter-spacing:2px;color:var(--txt)}
.dc-sub{font-size:11px;color:var(--txt3);letter-spacing:1px;text-align:center}

/* â”€â”€ GAME WRAPPER â”€â”€ */
#game{position:fixed;inset:0;display:none;flex-direction:column;background:var(--bg)}

/* â”€â”€ HUD â”€â”€ */
#hud{height:46px;flex-shrink:0;display:flex;align-items:center;padding:0 18px;gap:14px;
  background:rgba(0,0,0,.65);border-bottom:1px solid rgba(212,168,67,.12);z-index:10}
.hud-logo{font-size:14px;font-weight:700;color:var(--gold);letter-spacing:2px}
.hud-diff{font-size:9px;font-weight:700;letter-spacing:2px;padding:2px 8px;border-radius:4px;
  background:rgba(212,168,67,.1);color:var(--gold);border:1px solid rgba(212,168,67,.25)}
.hud-stats{display:flex;gap:22px;margin:0 auto}
.hs{display:flex;flex-direction:column;align-items:center;gap:1px}
.hs-l{font-size:8px;letter-spacing:2px;color:var(--txt3)}
.hs-v{font-family:'Roboto Mono',monospace;font-size:13px;color:var(--txt);font-weight:500}
.hud-right{display:flex;align-items:center;gap:12px}
.hud-chk{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--txt3);cursor:pointer}
.hud-chk input{accent-color:var(--gold);cursor:pointer}
.hud-btn{padding:4px 14px;border-radius:6px;border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);color:var(--txt2);
  font-family:inherit;font-size:12px;letter-spacing:1px;cursor:pointer;transition:all .12s}
.hud-btn:hover{background:rgba(255,255,255,.1);color:var(--txt)}

/* â”€â”€ CONTENT AREA â”€â”€ */
#content{flex:1;display:flex;overflow:hidden}
#table-wrap{flex:1;display:flex;align-items:center;justify-content:center;
  padding:14px 12px 6px}

/* â”€â”€ TABLE â”€â”€ */
#table{
  width:min(820px,100%);
  display:flex;flex-direction:column;align-items:center;gap:0;
  background:radial-gradient(ellipse 95% 90% at 50% 50%,
    #2a8040 0%,var(--felt1) 35%,var(--felt2) 65%,var(--felt3) 100%);
  border-radius:200px / 120px;
  border:16px solid var(--rail2);
  outline:3px solid var(--rail3);
  box-shadow:
    0 0 0 5px var(--rail1),
    0 0 0 8px var(--rail3),
    0 28px 100px rgba(0,0,0,.9),
    inset 0 0 80px rgba(0,0,0,.28),
    inset 0 3px 20px rgba(255,255,255,.03);
  padding:22px 80px 18px;
  position:relative;
}

/* â”€â”€ PLAYER PANELS â”€â”€ */
.panel{display:flex;align-items:center;gap:10px;
  background:rgba(0,0,0,.58);border:1px solid rgba(255,255,255,.08);
  border-radius:36px;padding:8px 18px 8px 9px;
  font-family:inherit;position:relative;transition:border-color .2s,box-shadow .2s}
.panel.acting{border-color:rgba(52,211,120,.6);
  box-shadow:0 0 0 2px rgba(52,211,120,.18),0 0 18px rgba(52,211,120,.14)}
.p-face{width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.p-info{display:flex;flex-direction:column;gap:3px}
.p-name{font-size:13px;font-weight:600;letter-spacing:2px;color:#c8c0a8;
  display:flex;align-items:center;gap:6px}
.p-stack{font-family:'Roboto Mono',monospace;font-size:16px;color:var(--gold);font-weight:500}
.d-btn{width:22px;height:22px;border-radius:50%;background:var(--gold);color:#000;
  font-family:'Roboto Mono',monospace;font-size:10px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  border:2px solid rgba(0,0,0,.4);margin-left:4px;flex-shrink:0}
.blind{font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px}
.bl-sb{background:rgba(36,113,163,.3);color:#5dade2;border:1px solid rgba(36,113,163,.4)}
.bl-bb{background:rgba(192,57,43,.3);color:#ec7063;border:1px solid rgba(192,57,43,.4)}

/* Action popup */
.apop{position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%);
  background:rgba(8,15,9,.92);border:1px solid rgba(255,255,255,.18);border-radius:7px;
  padding:4px 12px;font-size:14px;font-weight:700;letter-spacing:1px;
  color:#fff;white-space:nowrap;pointer-events:none;z-index:40;
  animation:pop .15s ease;font-family:inherit}
@keyframes pop{from{opacity:0;transform:translateX(-50%) scale(.8) translateY(4px)}to{opacity:1;transform:translateX(-50%) scale(1) translateY(0)}}
.ap-fold{color:#e74c3c}.ap-check{color:#2ecc71}.ap-call{color:#3498db}
.ap-raise,.ap-bet{color:#e67e22}.ap-draw,.ap-pat{color:#9b59b6}

/* â”€â”€ CARD ZONES â”€â”€ */
#ai-row,#player-row{width:100%;display:flex;flex-direction:column;align-items:center;gap:7px}
#ai-info{font-family:'Roboto Mono',monospace;font-size:11px;color:var(--txt3);min-height:15px;letter-spacing:1px}
#draw-instruction{font-size:13px;font-weight:600;letter-spacing:2px;color:var(--gold);min-height:18px;text-align:center}

.cards{display:flex;gap:9px;justify-content:center;align-items:flex-end;
  min-height:112px;padding:4px 0;width:100%}

/* â”€â”€ CARDS â”€â”€ */
.card{width:var(--card-w);height:var(--card-h);border-radius:8px;flex-shrink:0;
  position:relative;cursor:default;
  box-shadow:0 5px 16px rgba(0,0,0,.65),0 1px 3px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.8);
  transition:transform .15s ease,box-shadow .15s ease;
  animation:deal .28s ease backwards;will-change:transform}
@keyframes deal{from{opacity:0;transform:translateY(-26px) scale(.78)}to{opacity:1;transform:translateY(0) scale(1)}}
.card.up{background:#fefcf2;border:1px solid rgba(0,0,0,.16)}
.card.dn{background:linear-gradient(148deg,#1c3d9c,#0e2060);border:1px solid rgba(255,255,255,.1)}
.card.dn::after{content:'';position:absolute;inset:5px;border-radius:5px;
  border:1px solid rgba(255,255,255,.09);
  background:repeating-linear-gradient(45deg,rgba(255,255,255,.04) 0,rgba(255,255,255,.04) 2px,transparent 2px,transparent 8px)}
.c-tl{position:absolute;top:4px;left:6px;display:flex;flex-direction:column;line-height:1}
.c-br{position:absolute;bottom:4px;right:6px;display:flex;flex-direction:column;line-height:1;transform:rotate(180deg)}
.c-rk{font-family:'Roboto Mono',monospace;font-size:19px;font-weight:700;letter-spacing:-1px}
.c-su{font-size:13px;margin-top:-1px}
.c-mid{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;line-height:1}
.red{color:#c0392b}.blk{color:#111}
/* Selectable */
.card.pick{cursor:pointer}
.card.pick:hover:not(.sel){transform:translateY(-10px);
  box-shadow:0 14px 28px rgba(0,0,0,.65),0 0 0 2px rgba(255,255,255,.3)}
.card.sel{transform:translateY(-20px) !important;
  box-shadow:0 20px 38px rgba(0,0,0,.7),0 0 0 3px var(--gold),0 0 22px var(--goldglow) !important}
.card.win{animation:wglow .7s ease infinite alternate}
@keyframes wglow{from{box-shadow:0 5px 16px rgba(0,0,0,.6),0 0 0 2px var(--gold)}to{box-shadow:0 5px 26px rgba(0,0,0,.6),0 0 0 3px var(--gold2),0 0 30px var(--goldglow)}}
.card.flip{animation:cardflip .3s ease backwards}
@keyframes cardflip{from{transform:rotateY(80deg);opacity:0}to{transform:rotateY(0);opacity:1}}

/* â”€â”€ CENTER STRIP â”€â”€ */
#center{display:flex;align-items:center;justify-content:center;gap:20px;
  width:100%;padding:5px 0}
.bet-side{font-family:'Roboto Mono',monospace;font-size:12px;color:var(--gold);
  min-width:88px;text-align:center;min-height:20px}
#cinfo{display:flex;flex-direction:column;align-items:center;gap:5px}
#phase{font-size:10px;font-weight:600;letter-spacing:4px;color:rgba(130,180,110,.65)}
#pot{display:flex;align-items:center;gap:7px;
  background:rgba(0,0,0,.52);border:1px solid rgba(212,168,67,.25);
  border-radius:22px;padding:5px 18px;
  font-family:'Roboto Mono',monospace;font-size:17px;color:var(--gold);letter-spacing:1px;
  box-shadow:0 2px 10px rgba(0,0,0,.4)}
#betsz{font-size:10px;font-weight:600;letter-spacing:3px;color:var(--txt3);min-height:14px}

/* â”€â”€ BUTTONS â”€â”€ */
#btn-zone{display:flex;align-items:center;justify-content:center;
  min-height:54px;padding:6px 0 0;width:100%}
.bgrp{display:none;gap:9px;align-items:center}
.bgrp.on{display:flex}
.b{height:50px;min-width:96px;padding:0 20px;border:none;border-radius:10px;
  cursor:pointer;font-family:inherit;font-size:18px;font-weight:700;letter-spacing:1.5px;
  transition:filter .1s,transform .08s;
  box-shadow:0 4px 14px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.16);
  position:relative}
.b:disabled{opacity:.26;cursor:not-allowed}
.b:not(:disabled):hover{filter:brightness(1.12)}
.b:not(:disabled):active{transform:scale(.96) translateY(1px);filter:brightness(1.02)}
.b-fold{background:linear-gradient(158deg,#7a1414,#c0392b);color:#fff;border-bottom:3px solid #5a0c0c}
.b-check{background:linear-gradient(158deg,#145222,#27ae60);color:#fff;border-bottom:3px solid #0c3416}
.b-call{background:linear-gradient(158deg,#10336a,#2471a3);color:#fff;border-bottom:3px solid #082048}
.b-raise{background:linear-gradient(158deg,#623200,#e67e22);color:#fff;border-bottom:3px solid #3a1e00}
.b-pat{background:linear-gradient(158deg,#145222,#27ae60);color:#fff;border-bottom:3px solid #0c3416}
.b-draw{background:linear-gradient(158deg,#3a1460,#8e44ad);color:#fff;border-bottom:3px solid #220c3c}

/* â”€â”€ MSG â”€â”€ */
#msg{height:24px;display:flex;align-items:center;justify-content:center}
#msg-t{font-size:12px;font-weight:600;letter-spacing:2px;color:var(--txt3)}

/* â”€â”€ HISTORY PANEL â”€â”€ */
#hist{position:fixed;right:0;top:46px;bottom:0;width:194px;
  background:rgba(4,10,5,.96);border-left:1px solid rgba(212,168,67,.1);
  display:flex;flex-direction:column}
.hist-h{padding:10px 14px;font-size:10px;font-weight:700;letter-spacing:4px;
  color:var(--gold);border-bottom:1px solid rgba(212,168,67,.08)}
#hist-l{flex:1;overflow-y:auto;padding:6px}
#hist-l::-webkit-scrollbar{width:3px}
#hist-l::-webkit-scrollbar-thumb{background:rgba(212,168,67,.18);border-radius:2px}
.he{padding:7px 9px;border-left:3px solid transparent;border-radius:0 5px 5px 0;
  background:rgba(255,255,255,.022);margin-bottom:4px;
  font-family:'Roboto Mono',monospace;font-size:10px;line-height:1.75;color:var(--txt3)}
.he.w{border-left-color:#27ae60}.he.l{border-left-color:#c0392b}.he.p{border-left-color:#7f8c8d}
.he-r{font-size:11px;color:#c0b88a}
.he-d{font-size:9px;color:#3a6040}

/* â”€â”€ RESULT OVERLAY â”€â”€ */
#result{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);
  align-items:center;justify-content:center;z-index:600;animation:fin .2s ease}
#result.on{display:flex}
@keyframes fin{from{opacity:0}to{opacity:1}}
#rbox{background:linear-gradient(155deg,#1c4824,#0c1a0e);
  border:1px solid rgba(212,168,67,.35);border-radius:18px;
  padding:40px 54px;text-align:center;min-width:340px;
  box-shadow:0 30px 100px #000c,0 0 50px rgba(212,168,67,.1);
  animation:rboxin .22s ease;font-family:inherit}
@keyframes rboxin{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
#r-icon{font-size:56px;margin-bottom:10px}
#r-title{font-size:32px;font-weight:700;letter-spacing:4px;color:var(--txt);margin-bottom:12px}
#r-desc{font-family:'Roboto Mono',monospace;font-size:12px;color:var(--txt3);line-height:2;margin-bottom:8px}
#r-pot{font-size:18px;font-weight:600;letter-spacing:2px;color:var(--gold)}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobby">
  <div class="logo">
    <div class="logo-suits"><span class="b">â™ </span><span class="r">â™¥</span><span class="r">â™¦</span><span class="b">â™£</span></div>
    <h1>2-7 TRIPLE DRAW</h1>
    <p>HEADS-UP LIMIT LOWBALL POKER</p>
  </div>
  <div>
    <p class="diff-label">SELECT DIFFICULTY</p>
    <div class="diff-row">
      <button class="dc" data-d="easy"><div class="dc-icon">ğŸ²</div><div class="dc-name">EASY</div><div class="dc-sub">Loose &amp; passive</div></button>
      <button class="dc rec" data-d="medium"><span class="rec-tag">RECOMMENDED</span><div class="dc-icon">ğŸ¯</div><div class="dc-name">MEDIUM</div><div class="dc-sub">Balanced play</div></button>
      <button class="dc" data-d="hard"><div class="dc-icon">ğŸ”¥</div><div class="dc-name">HARD</div><div class="dc-sub">Reads your patterns</div></button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="game">
  <!-- HUD -->
  <div id="hud">
    <span class="hud-logo">â™  2-7 TRIPLE DRAW</span>
    <span class="hud-diff" id="hd"></span>
    <div class="hud-stats">
      <div class="hs"><span class="hs-l">HANDS</span><span class="hs-v" id="sh">0</span></div>
      <div class="hs"><span class="hs-l">NET BB</span><span class="hs-v" id="sn">+0</span></div>
      <div class="hs"><span class="hs-l">WIN%</span><span class="hs-v" id="sw">â€”</span></div>
    </div>
    <div class="hud-right">
      <label class="hud-chk"><input type="checkbox" id="chk">Show AI cards</label>
      <button class="hud-btn" id="btn-lob">Lobby</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">
    <div id="table-wrap">
      <div id="table">

        <!-- AI -->
        <div id="ai-row">
          <div class="panel" id="ai-p">
            <div class="p-face">ğŸ¤–</div>
            <div class="p-info">
              <div class="p-name">AI <span id="ai-bl" class="blind"></span></div>
              <div class="p-stack" id="ai-stk">100 BB</div>
            </div>
            <div class="d-btn" id="ai-d" style="display:none">D</div>
          </div>
          <div id="ai-info"></div>
        </div>
        <div class="cards" id="ai-cards"></div>

        <!-- CENTER -->
        <div id="center">
          <div class="bet-side" id="bl"></div>
          <div id="cinfo">
            <div id="phase">PRE-DRAW</div>
            <div id="pot"><span>ğŸª™</span><span id="pot-v">0 BB</span></div>
            <div id="betsz"></div>
          </div>
          <div class="bet-side" id="br"></div>
        </div>

        <!-- PLAYER CARDS -->
        <div class="cards" id="pl-cards"></div>

        <!-- PLAYER -->
        <div id="player-row">
          <div class="panel" id="pl-p">
            <div class="p-face">ğŸ˜</div>
            <div class="p-info">
              <div class="p-name">YOU <span id="pl-bl" class="blind"></span></div>
              <div class="p-stack" id="pl-stk">100 BB</div>
            </div>
            <div class="d-btn" id="pl-d" style="display:none">D</div>
          </div>
          <div id="draw-instruction"></div>
        </div>

        <!-- BUTTONS -->
        <div id="btn-zone">
          <div class="bgrp" id="bet-g">
            <button class="b b-fold" id="bf">FOLD</button>
            <button class="b b-check" id="bc">CHECK</button>
            <button class="b b-call" id="bl2">CALL</button>
            <button class="b b-raise" id="br2">RAISE</button>
          </div>
          <div class="bgrp" id="draw-g">
            <button class="b b-pat" id="bpat">STAND PAT</button>
            <button class="b b-draw" id="bdraw">DRAW <span id="dn">0</span></button>
          </div>
        </div>

        <!-- MSG -->
        <div id="msg"><span id="msg-t"></span></div>

      </div><!-- /table -->
    </div><!-- /table-wrap -->

    <!-- HISTORY -->
    <div id="hist">
      <div class="hist-h">HAND HISTORY</div>
      <div id="hist-l"></div>
    </div>
  </div><!-- /content -->
</div><!-- /game -->

<!-- RESULT -->
<div id="result">
  <div id="rbox">
    <div id="r-icon"></div>
    <div id="r-title"></div>
    <div id="r-desc"></div>
    <div id="r-pot"></div>
  </div>
</div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & DECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RANKS=['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
const SUITS=['c','d','h','s'];
const RV={'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'T':10,'J':11,'Q':12,'K':13,'A':14};
const SS={c:'â™£',d:'â™¦',h:'â™¥',s:'â™ '};
const SB=.5,BB=1,BIG=2,SMALL=1,CAP=4,START=100;

const mkDeck=()=>{const d=[];for(const s of SUITS)for(const r of RANKS)d.push({r,s});return d;};
const shuffle=a=>{const d=[...a];for(let i=d.length-1;i>0;i--){const j=0|Math.random()*(i+1);[d[i],d[j]]=[d[j],d[i]];}return d;};
const take=(d,n)=>d.splice(0,n);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HAND EVALUATION
   Lower category = better hand in 2-7 lowball
   Aces high, straights & flushes count against you
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function evalHand(cards){
  const vals=cards.map(c=>RV[c.r]).sort((a,b)=>b-a);
  const suits=cards.map(c=>c.s);
  const flush=suits.every(s=>s===suits[0]);
  const uniq=[...new Set(vals)];
  const straight=uniq.length===5&&vals[0]-vals[4]===4;
  const freq={};
  for(const v of vals)freq[v]=(freq[v]||0)+1;
  const cnts=Object.values(freq).sort((a,b)=>b-a);
  const grps=Object.entries(freq).map(([v,c])=>({v:+v,c})).sort((a,b)=>b.c-a.c||b.v-a.v);
  let cat;
  if(straight&&flush)cat=9;
  else if(cnts[0]===4)cat=8;
  else if(cnts[0]===3&&cnts[1]===2)cat=7;
  else if(flush)cat=6;
  else if(straight)cat=5;
  else if(cnts[0]===3)cat=4;
  else if(cnts[0]===2&&cnts[1]===2)cat=3;
  else if(cnts[0]===2)cat=2;
  else cat=1;
  return{cat,grps,vals};
}
// negative = A is better (lower in 2-7)
function cmp(a,b){
  if(a.cat!==b.cat)return a.cat-b.cat;
  for(let i=0;i<Math.max(a.grps.length,b.grps.length);i++){
    const av=a.grps[i]?.v??0,bv=b.grps[i]?.v??0;
    if(av!==bv)return bv-av;
  }
  return 0;
}
function desc(ev){
  const rn=v=>({10:'T',11:'J',12:'Q',13:'K',14:'A'}[v]||String(v));
  const t=rn(ev.grps[0].v),s=ev.grps[1]?rn(ev.grps[1].v):'';
  const N=['','HC','Pair','TwoPair','Trips','Straight','Flush','FullHouse','Quads','StrFlush'];
  if(ev.cat===1)return t+'-high';
  if(ev.cat===2)return 'Pair of '+t+'s';
  return N[ev.cat]+(s?' '+t+'/'+s:'');
}
function score(cards){
  const e=evalHand(cards);
  let s=(e.cat-1)*1e6;
  for(let i=0;i<e.vals.length;i++)s+=e.vals[i]*Math.pow(15,4-i);
  return s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI DISCARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function aiDiscard(hand,diff,drawN,oppPats){
  let best=Infinity,bestMask=0;
  for(let mask=1;mask<32;mask++){
    const kept=hand.filter((_,i)=>mask&(1<<i));
    const f={};for(const c of kept){const v=RV[c.r];f[v]=(f[v]||0)+1;}
    let s=0;
    for(const c of kept){
      const v=RV[c.r];
      s+=v*3;
      if(v===14)s+=32;if(v>7)s+=(v-7)*5;
      s+=(f[v]-1)*32;
    }
    if(kept.length>=3){const us=new Set(kept.map(c=>c.s));if(us.size===1)s+=20;}
    if(s<best){best=s;bestMask=mask;}
  }
  const disc=hand.map((_,i)=>i).filter(i=>!(bestMask&(1<<i)));
  if(diff==='hard'&&drawN<=2&&disc.length===1&&!oppPats&&Math.random()<.12)return[];
  if(diff==='easy'&&Math.random()<.22)
    return [...disc,...hand.map((_,i)=>i).filter(i=>!disc.includes(i)&&Math.random()<.25)].slice(0,5);
  return disc;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let G=null;
function init(diff){
  G={
    diff,deck:[],ph:[],ah:[],
    pStk:START,aStk:START,
    pot:0,pBet:0,aBet:0,betSz:SMALL,cap:0,
    rnd:0,drawN:0,phase:'idle',
    dealer:'player',sel:new Set(),
    aDisc:[],aDraw:[],pDraw:[],
    stats:{h:0,w:0,l:0,net:0},
    oppFolds:0,oppH:0,oppPats:0,
    showAI:false,startStk:START,
    _res:null,_dres:null,act:false,
    folded:false,fWinner:null
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $=id=>document.getElementById(id);
const raf=fn=>requestAnimationFrame(fn);
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fmt=n=>n===Math.floor(n)?''+n:(Math.round(n*2)/2).toFixed(1).replace('.0','');
const msg=m=>($('msg-t').textContent=m);

/* â”€â”€ Card elements â”€â”€ */
function mkCard(card,dn=false,delay=0){
  const el=document.createElement('div');
  el.className='card '+(dn?'dn':'up');
  el.style.animationDelay=delay+'s';
  if(dn)return el;
  const red=card.s==='h'||card.s==='d';
  const cl=red?'red':'blk',su=SS[card.s],rk=card.r;
  el.innerHTML=
    `<div class="c-tl"><span class="c-rk ${cl}">${rk}</span><span class="c-su ${cl}">${su}</span></div>`+
    `<span class="c-mid ${cl}">${su}</span>`+
    `<div class="c-br"><span class="c-rk ${cl}">${rk}</span><span class="c-su ${cl}">${su}</span></div>`;
  return el;
}

function renderAI(reveal=false){
  const z=$('ai-cards');z.innerHTML='';
  G.ah.forEach((c,i)=>{
    const el=reveal?mkCard(c,false,i*.06):mkCard(null,true,i*.06);
    if(reveal)el.classList.add('flip');
    z.appendChild(el);
  });
}

function renderPlayer(pickable=false){
  const z=$('pl-cards');z.innerHTML='';
  G.ph.forEach((c,i)=>{
    const el=mkCard(c,false,i*.06);
    if(pickable){
      el.classList.add('pick');
      if(G.sel.has(i))el.classList.add('sel');
      el.addEventListener('click',()=>{
        if(G.phase!=='drawing')return;
        G.sel.has(i)?G.sel.delete(i):G.sel.add(i);
        el.classList.toggle('sel');
        updSel();
      });
    }
    z.appendChild(el);
  });
}

function updSel(){
  const n=G.sel.size;
  $('dn').textContent=n;
  $('draw-instruction').textContent=n>0
    ?`${n} CARD${n>1?'S':''} SELECTED â€” HIT DRAW TO DISCARD`
    :'CLICK CARDS TO MARK FOR DISCARD';
}

/* â”€â”€ Display update â€” batched via rAF â”€â”€ */
let _dispPending=false;
function updDisp(){
  if(_dispPending)return;
  _dispPending=true;
  raf(()=>{
    _dispPending=false;
    $('pl-stk').textContent=fmt(G.pStk)+' BB';
    $('ai-stk').textContent=fmt(G.aStk)+' BB';
    $('pot-v').textContent=fmt(G.pot)+' BB';
    const rn=['PRE-DRAW BETTING','AFTER DRAW 1','AFTER DRAW 2','FINAL BETTING'];
    $('phase').textContent=rn[G.rnd]||'â€”';
    $('betsz').textContent=G.phase==='drawing'?'DRAW '+G.drawN+' OF 3':'BET SIZE: '+fmt(G.betSz)+' BB';
    // Dealer / blinds
    const pisd=G.dealer==='player';
    $('pl-d').style.display=pisd?'flex':'none';
    $('ai-d').style.display=pisd?'none':'flex';
    const pb=$('pl-bl'),ab=$('ai-bl');
    pb.textContent=pisd?'SB':'BB';pb.className='blind '+(pisd?'bl-sb':'bl-bb');
    ab.textContent=pisd?'BB':'SB';ab.className='blind '+(pisd?'bl-bb':'bl-sb');
    // Bets in pot area
    $('bl').textContent=G.aBet>0?'ğŸ”´ '+fmt(G.aBet)+' BB':'';
    $('br').textContent=G.pBet>0?'ğŸ”µ '+fmt(G.pBet)+' BB':'';
    // AI draw history
    $('ai-info').textContent=G.aDraw.length?'AI drew: '+G.aDraw.join(' â†’ '):'';
    updStats();
  });
}

function updStats(){
  const{h,w,net}=G.stats;
  $('sh').textContent=h;
  const ne=$('sn');ne.textContent=(net>=0?'+':'')+fmt(net);
  ne.style.color=net>=0?'#27ae60':'#c0392b';
  $('sw').textContent=h?((w/h)*100).toFixed(1)+'%':'â€”';
  $('hd').textContent=G.diff.toUpperCase();
}

/* â”€â”€ Controls â”€â”€ */
function showBet(){
  $('bet-g').classList.add('on');$('draw-g').classList.remove('on');
  const call=Math.max(0,G.aBet-G.pBet);
  const chk=G.pBet>=G.aBet,canC=call>0&&G.pStk>0,canR=G.cap<CAP&&G.pStk>0;
  $('bf').disabled=false;
  $('bc').disabled=!chk;
  $('bl2').disabled=!canC;
  $('br2').disabled=!canR;
  $('bl2').textContent=canC?'CALL '+fmt(call):'CALL';
  $('br2').textContent='RAISE '+fmt(G.betSz);
  $('ai-p').classList.remove('acting');$('pl-p').classList.add('acting');
}
function showDraw(){
  $('bet-g').classList.remove('on');$('draw-g').classList.add('on');
  $('bpat').disabled=false;$('bdraw').disabled=false;
  $('dn').textContent='0';
  $('ai-p').classList.remove('acting');$('pl-p').classList.add('acting');
  $('draw-instruction').textContent='CLICK CARDS TO MARK FOR DISCARD';
}
function hideCtrl(){
  $('bet-g').classList.remove('on');$('draw-g').classList.remove('on');
  $('pl-p').classList.remove('acting');$('ai-p').classList.remove('acting');
  $('draw-instruction').textContent='';
}

/* â”€â”€ Action popups â”€â”€ */
const ptimers={};
function pop(who,text,cl){
  const seat=$(who==='ai'?'ai-p':'pl-p');
  const old=seat.querySelector('.apop');if(old)old.remove();
  const el=document.createElement('div');
  el.className='apop ap-'+cl;el.textContent=text;
  seat.appendChild(el);
  clearTimeout(ptimers[who]);
  ptimers[who]=setTimeout(()=>el.parentNode&&el.remove(),1700);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BETTING ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function promptBet(){
  return new Promise(res=>{G.act=true;G._res=res;updDisp();showBet();});
}
function resAct(a){
  if(!G.act)return;G.act=false;hideCtrl();
  const r=G._res;G._res=null;if(r)r(a);
}

async function aiAct(){
  $('ai-p').classList.add('acting');
  // Fixed delay for smoothness
  await sleep(480+Math.random()*320);
  const sc=score(G.ah),{diff}=G;
  const facing=G.aBet<G.pBet,callAmt=Math.max(0,G.pBet-G.aBet),dl=3-G.drawN;
  let fT=diff==='easy'?4e6:diff==='medium'?3e6:2.2e6;
  let rT=diff==='easy'?9e5:diff==='medium'?7e5:5e5;
  if(diff==='hard'){
    const fr=G.oppH>0?G.oppFolds/G.oppH:0;
    if(fr>.4)rT*=1.3;
    const lp=G.pDraw[G.pDraw.length-1]||0;
    if(lp>=2){rT*=.75;fT*=.9;}
    if(lp===0&&G.drawN>0){fT*=.75;rT*=1.5;}
  }
  if(dl>1){fT*=1.3;rT*=1.1;}
  const canR=G.cap<CAP&&G.aStk>0;
  let action;
  if(!facing){
    if(sc<rT&&canR){
      const p=Math.min(G.betSz,G.aStk);G.aStk-=p;G.aBet+=p;G.pot+=p;G.cap++;
      pop('ai','BET '+fmt(G.betSz),'bet');msg('AI bets '+fmt(G.betSz)+' BB.');action='bet';
    }else{pop('ai','CHECK','check');msg('AI checks.');action='check';}
  }else{
    if(sc>fT){
      pop('ai','FOLD','fold');msg('AI folds.');
      G.folded=true;G.fWinner='player';
      $('ai-p').classList.remove('acting');updDisp();return'fold';
    }
    if(sc<rT&&canR){
      const cp=Math.min(callAmt,G.aStk),rp=Math.min(G.betSz,G.aStk-cp);
      G.aStk-=(cp+rp);G.aBet+=(cp+rp);G.pot+=(cp+rp);G.cap++;
      pop('ai','RAISE '+fmt(G.betSz),'raise');msg('AI raises to '+fmt(G.aBet)+' BB.');action='raise';
    }else{
      const p=Math.min(callAmt,G.aStk);G.aStk-=p;G.aBet+=p;G.pot+=p;
      pop('ai','CALL '+fmt(callAmt),'call');msg('AI calls.');action='call';
    }
  }
  $('ai-p').classList.remove('acting');updDisp();return action;
}

async function runBet(pFirst){
  G.pBet=0;G.aBet=0;G.cap=0;
  updDisp();
  for(let i=0;i<9;i++){
    if(G.folded||G.phase==='idle')return false;
    if(pFirst){
      await promptBet();
      if(G.folded||G.phase==='idle')return false;
      const r=await aiAct();
      if(r==='fold'||G.folded)return false;
      if(G.aBet<=G.pBet)break;
    }else{
      const r=await aiAct();
      if(r==='fold'||G.folded)return false;
      if(G.aBet>G.pBet){
        await promptBet();
        if(G.folded||G.phase==='idle')return false;
        if(G.pBet<=G.aBet)break;
      }else break;
    }
  }
  // Clear bet displays
  $('bl').textContent='';$('br').textContent='';
  return true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW ENGINE
   Players can discard 0-5 cards per draw round
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function promptDraw(){
  return new Promise(res=>{
    G.phase='drawing';G.sel=new Set();G._dres=res;
    updDisp();showDraw();
    renderPlayer(true);
    msg('DRAW '+G.drawN+': Click cards to discard, then press DRAW (or STAND PAT)');
  });
}

function doPlayerDraw(idxs){
  G.pDraw.push(idxs.length);
  if(!idxs.length)return;
  const news=take(G.deck,idxs.length);
  [...idxs].sort((a,b)=>b-a).forEach(i=>G.ph.splice(i,1));
  G.ph.push(...news);
  msg('You drew '+idxs.length+' card'+(idxs.length!==1?'s':'')+'.');
}

async function doAIDraw(){
  $('ai-p').classList.add('acting');
  await sleep(520+Math.random()*280);
  const idxs=aiDiscard(G.ah,G.diff,G.drawN,G.oppPats);
  G.aDisc.push(idxs.map(i=>({...G.ah[i]})));
  G.aDraw.push(idxs.length);
  if(!idxs.length){
    pop('ai','STAND PAT','pat');msg('AI stands pat.');G.oppPats++;
  }else{
    pop('ai','DRAW '+idxs.length,'draw');msg('AI draws '+idxs.length+'.');
    const news=take(G.deck,idxs.length);
    [...idxs].sort((a,b)=>b-a).forEach(i=>G.ah.splice(i,1));
    G.ah.push(...news);
  }
  $('ai-p').classList.remove('acting');
  renderAI(false);
  updDisp();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addHist(o){
  const el=document.createElement('div');
  el.className='he '+(o.w==='player'?'w':o.w==='ai'?'l':'p');
  const sg=o.w==='player'?'+':o.w==='ai'?'-':'Â±';
  let h=`<div class="he-r">Hand #${o.n} â€” ${sg}${fmt(o.pot)} BB</div>`;
  if(o.type==='fold')h+='<div class="he-d">Won by fold</div>';
  if(o.pd)h+=`<div class="he-d">You: ${o.pd}</div>`;
  if(o.ad)h+=`<div class="he-d">AI: ${o.ad}</div>`;
  if(o.aidc&&G.showAI)h+=`<div class="he-d" style="color:#7a50a0">AI disc: ${o.aidc}</div>`;
  el.innerHTML=h;
  $('hist-l').prepend(el);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULT OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResult(winner,pd,ad,pot){
  const icon=winner==='player'?'ğŸ†':winner==='ai'?'ğŸ’€':'ğŸ¤';
  const title=winner==='player'?'YOU WIN!':winner==='ai'?'AI WINS':'SPLIT POT';
  const col=winner==='player'?'#d4a843':winner==='ai'?'#e74c3c':'#888';
  $('r-icon').textContent=icon;
  $('r-title').textContent=title;$('r-title').style.color=col;
  $('r-desc').innerHTML='Your hand: '+pd+'<br>AI hand:&nbsp;&nbsp;'+ad;
  $('r-pot').textContent='POT: '+fmt(pot)+' BB';
  $('result').classList.add('on');
  setTimeout(()=>$('result').classList.remove('on'),2600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HAND FLOW
   Structure per official rules:
   1. Post blinds
   2. Pre-draw betting (SB acts first heads-up)
   3. Draw 1
   4. Post-draw betting 1 (BB acts first)
   5. Draw 2
   6. Post-draw betting 2 (BB acts first)
   7. Draw 3
   8. Post-draw betting 3 / final betting (BB acts first)
   9. Showdown
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function playHand(){
  if(!G)return;
  G.phase='betting';G.folded=false;G.fWinner=null;
  G.pot=0;G.pBet=0;G.aBet=0;G.cap=0;
  G.rnd=0;G.drawN=0;G.betSz=SMALL;
  G.aDisc=[];G.aDraw=[];G.pDraw=[];
  G.sel=new Set();G.oppPats=0;
  G.startStk=G.pStk;

  G.deck=shuffle(mkDeck());
  G.ph=take(G.deck,5);G.ah=take(G.deck,5);

  hideCtrl();$('draw-instruction').textContent='';$('ai-info').textContent='';
  $('bl').textContent='';$('br').textContent='';
  msg('Dealing...');renderAI(false);renderPlayer(false);
  updDisp();
  await sleep(280);

  // Post blinds
  const pisd=G.dealer==='player'; // player=button=SB heads-up
  if(pisd){
    const sp=Math.min(SB,G.pStk);G.pStk-=sp;G.pBet=sp;G.pot+=sp;
    const bp=Math.min(BB,G.aStk);G.aStk-=bp;G.aBet=bp;G.pot+=bp;
  }else{
    const sp=Math.min(SB,G.aStk);G.aStk-=sp;G.aBet=sp;G.pot+=sp;
    const bp=Math.min(BB,G.pStk);G.pStk-=bp;G.pBet=bp;G.pot+=bp;
  }
  updDisp();
  msg(pisd?'You: SB 0.5 BB  |  AI: BB 1 BB':'AI: SB 0.5 BB  |  You: BB 1 BB');
  await sleep(300);

  // â”€â”€ Round 0: pre-draw â€” SB (button) acts first heads-up â”€â”€
  G.rnd=0;G.betSz=SMALL;
  if(!await runBet(pisd)){await endFold();return;}

  // â”€â”€ Draw 1 â”€â”€ player first, then AI
  G.drawN=1;updDisp();
  const d1=await promptDraw();
  G.phase='betting';doPlayerDraw(d1);renderPlayer(false);
  await doAIDraw();

  // â”€â”€ Round 1: after draw 1 â€” BB (non-button) acts first â”€â”€
  G.rnd=1;G.betSz=SMALL;G.phase='betting';updDisp();
  if(!await runBet(!pisd)){await endFold();return;}

  // â”€â”€ Draw 2 â”€â”€
  G.drawN=2;updDisp();
  const d2=await promptDraw();
  G.phase='betting';doPlayerDraw(d2);renderPlayer(false);
  await doAIDraw();

  // â”€â”€ Round 2: after draw 2 â€” big bets â€” BB acts first â”€â”€
  G.rnd=2;G.betSz=BIG;G.phase='betting';updDisp();
  if(!await runBet(!pisd)){await endFold();return;}

  // â”€â”€ Draw 3 â”€â”€
  G.drawN=3;updDisp();
  const d3=await promptDraw();
  G.phase='betting';doPlayerDraw(d3);renderPlayer(false);
  await doAIDraw();

  // â”€â”€ Round 3: final betting â€” big bets â€” BB acts first â”€â”€
  G.rnd=3;G.betSz=BIG;G.phase='betting';updDisp();
  if(!await runBet(!pisd)){await endFold();return;}

  // â”€â”€ Showdown â”€â”€
  await endShowdown();
}

async function endFold(){
  const w=G.fWinner||'player',pot=G.pot;
  if(w==='player'){G.pStk+=pot;G.stats.w++;G.oppFolds++;}
  else{G.aStk+=pot;G.stats.l++;}
  G.stats.h++;G.oppH++;G.stats.net+=G.pStk-G.startStk;
  G.phase='idle';hideCtrl();
  $('bl').textContent='';$('br').textContent='';
  msg(w==='player'?'AI folded â€” You win '+fmt(pot)+' BB!':'You folded â€” AI wins '+fmt(pot)+' BB.');
  addHist({n:G.stats.h,w,pot,type:'fold'});
  updDisp();
  G.dealer=G.dealer==='player'?'ai':'player';
  await sleep(1600);next();
}

async function endShowdown(){
  G.phase='showdown';
  const pEv=evalHand(G.ph),aEv=evalHand(G.ah);
  const c=cmp(pEv,aEv),pd=desc(pEv),ad=desc(aEv),pot=G.pot;
  renderAI(true);
  await sleep(300);
  let w;
  if(c<0){w='player';G.pStk+=pot;G.stats.w++;
    document.querySelectorAll('#pl-cards .card').forEach(e=>e.classList.add('win'));}
  else if(c>0){w='ai';G.aStk+=pot;G.stats.l++;
    document.querySelectorAll('#ai-cards .card').forEach(e=>e.classList.add('win'));}
  else{w='push';G.pStk+=pot/2;G.aStk+=pot/2;}
  G.stats.h++;G.oppH++;G.stats.net+=G.pStk-G.startStk;
  const aidc=G.aDisc.map(a=>a.map(c=>c.r+SS[c.s]).join(' ')||'â€”').join(' / ');
  showResult(w,pd,ad,pot);
  addHist({n:G.stats.h,w,pot,pd,ad,aidc,type:'showdown'});
  $('bl').textContent='';$('br').textContent='';
  G.dealer=G.dealer==='player'?'ai':'player';
  updDisp();
  await sleep(2800);
  document.querySelectorAll('.win').forEach(e=>e.classList.remove('win'));
  G.phase='idle';next();
}

function next(){
  if(G.pStk<=0){msg('You are out of chips!');updDisp();return;}
  if(G.aStk<=0){msg('AI is out of chips â€” you win the session!');updDisp();return;}
  playHand();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  // Lobby difficulty selection
  document.querySelectorAll('.dc').forEach(btn=>{
    btn.addEventListener('click',()=>{
      init(btn.dataset.d);
      $('lobby').style.display='none';
      $('game').style.display='flex';
      updDisp();playHand();
    });
  });

  // FOLD
  $('bf').addEventListener('click',()=>{
    if(!G.act)return;
    G.fWinner='ai';G.folded=true;G.act=false;
    hideCtrl();pop('player','FOLD','fold');msg('You fold.');
    const r=G._res;G._res=null;if(r)r('fold');
    const d=G._dres;G._dres=null;if(d)d([]);
  });

  // CHECK
  $('bc').addEventListener('click',()=>{
    if(!G.act||G.pBet<G.aBet)return;
    pop('player','CHECK','check');msg('You check.');resAct('check');
  });

  // CALL
  $('bl2').addEventListener('click',()=>{
    if(!G.act)return;
    const amt=Math.min(Math.max(0,G.aBet-G.pBet),G.pStk);
    if(amt<=0)return;
    G.pStk-=amt;G.pBet+=amt;G.pot+=amt;
    pop('player','CALL '+fmt(amt),'call');msg('You call '+fmt(amt)+' BB.');
    updDisp();resAct('call');
  });

  // RAISE
  $('br2').addEventListener('click',()=>{
    if(!G.act||G.cap>=CAP)return;
    const call=Math.min(Math.max(0,G.aBet-G.pBet),G.pStk);
    const raise=Math.min(G.betSz,G.pStk-call);
    if(call+raise<=0)return;
    G.pStk-=(call+raise);G.pBet+=(call+raise);G.pot+=(call+raise);G.cap++;
    pop('player','RAISE '+fmt(G.betSz),'raise');msg('You raise to '+fmt(G.pBet)+' BB.');
    updDisp();resAct('raise');
  });

  // STAND PAT â€” keep all cards, draw 0
  $('bpat').addEventListener('click',()=>{
    if(G.phase!=='drawing')return;
    G.sel=new Set();G.phase='betting';
    hideCtrl();$('draw-instruction').textContent='';
    pop('player','STAND PAT','pat');msg('You stand pat.');
    G.pDraw.push(0);
    const r=G._dres;G._dres=null;if(r)r([]);
  });

  // DRAW â€” discard selected cards, draw new ones
  $('bdraw').addEventListener('click',()=>{
    if(G.phase!=='drawing')return;
    const idxs=[...G.sel];
    G.sel=new Set();G.phase='betting';
    hideCtrl();$('draw-instruction').textContent='';
    // If 0 selected, same as stand pat
    if(idxs.length===0){
      pop('player','STAND PAT','pat');msg('You stand pat (drew 0).');
    }else{
      pop('player','DRAW '+idxs.length,'draw');
    }
    const r=G._dres;G._dres=null;if(r)r(idxs);
  });

  // Toggle AI discard reveal
  $('chk').addEventListener('change',e=>{G&&(G.showAI=e.target.checked);});

  // Lobby button
  $('btn-lob').addEventListener('click',()=>{
    if(!confirm('Return to lobby? Hand in progress will end.'))return;
    hideCtrl();$('game').style.display='none';$('lobby').style.display='flex';
  });
});
</script>
</body>
</html>
